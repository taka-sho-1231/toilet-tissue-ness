name: Auto Tag on Merge

on:
  pull_request:
    types: [closed]
    branches:
      - main  # 💡 mainブランチへのマージのみを対象にする場合 (不要なら削除)

# 権限の設定: タグをプッシュするために contents: write が必要
permissions:
  contents: write
  pull-requests: read # PRのラベル情報を読み取るために必要

jobs:
  tag:
    # mainブランチへのマージ、かつ PRがマージされた場合のみ実行
    # 💡 `on.pull_request.branches` を使わない場合は、 `github.event.pull_request.base.ref == 'main'` を削除
    if: github.event.pull_request.base.ref == 'main' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    # 💡 複数のマージが同時に行われた場合に備え、タグ付けジョブの同時実行を防ぐ
    concurrency:
      group: ${{ github.repository }}-tagging
      cancel-in-progress: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # 💡 全履歴を取得して、git describe が過去のタグを正しく見つけられるようにする
          fetch-depth: 0

      - name: Get latest stable tag
        id: get_tag
        run: |
          git fetch --tags
          # 💡 vX.Y.Z 形式の安定版タグのみを対象にし、存在しない場合は v0.0.0 を使用
          latest_tag=$(git describe --tags --abbrev=0 --match "v[0-9]*.[0-9]*.[0-9]*" 2>/dev/null || echo "v0.0.0")
          echo "latest_tag=$latest_tag" >> $GITHUB_OUTPUT
          echo "Found latest tag: $latest_tag"

      - name: Determine next version
        id: bump
        run: |
          # PRのラベルをJSONから抽出
          label_names=$(jq -r '.pull_request.labels[].name' <<< '${{ toJson(github.event) }}')
          
          version="${{ steps.get_tag.outputs.latest_tag }}"
          version="${version#v}" # "v" プレフィックスを削除
          
          IFS='.' read -r major minor patch <<< "$version"

          # 💡 PRのラベルに基づいてバージョンをインクリメント
          if echo "$label_names" | grep -qi "major"; then # -i で大文字小文字を区別しない
            major=$((major+1)); minor=0; patch=0
            echo "Bumping major version"
          elif echo "$label_names" | grep -qi "minor"; then
            minor=$((minor+1)); patch=0
            echo "Bumping minor version"
          elif echo "$label_names" | grep -qi "patch"; then
            patch=$((patch+1))
            echo "Bumping patch version"
          else
            echo "No version label (major, minor, patch) found. Skipping."
            echo "new_tag=" >> $GITHUB_OUTPUT # new_tagを空に設定
            exit 0 # 正常終了としてジョブを終了
          fi

          new_tag="v${major}.${minor}.${patch}"
          echo "New tag: $new_tag"
          echo "new_tag=$new_tag" >> $GITHUB_OUTPUT

      # 💡 タグをプッシュするボットの情報を設定
      - name: Configure Git
        if: steps.bump.outputs.new_tag != ''
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create and push new tag
        if: steps.bump.outputs.new_tag != '' # new_tag が設定されている場合のみ実行
        run: |
          new_tag="${{ steps.bump.outputs.new_tag }}"
          # 💡 マージコミット（github.sha）に対してタグを打つ
          echo "Creating and pushing tag: $new_tag"
          git tag "$new_tag" ${{ github.sha }}
          git push origin "$new_tag"
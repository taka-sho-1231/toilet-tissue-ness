name: Auto Tag on Merge

on:
  pull_request:
    types: [closed]
    branches:
      - main  # ğŸ’¡ mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒãƒ¼ã‚¸ã®ã¿ã‚’å¯¾è±¡ã«ã™ã‚‹å ´åˆ (ä¸è¦ãªã‚‰å‰Šé™¤)

# æ¨©é™ã®è¨­å®š: ã‚¿ã‚°ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹ãŸã‚ã« contents: write ãŒå¿…è¦
permissions:
  contents: write
  pull-requests: read # PRã®ãƒ©ãƒ™ãƒ«æƒ…å ±ã‚’èª­ã¿å–ã‚‹ãŸã‚ã«å¿…è¦

jobs:
  tag:
    # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒãƒ¼ã‚¸ã€ã‹ã¤ PRãŒãƒãƒ¼ã‚¸ã•ã‚ŒãŸå ´åˆã®ã¿å®Ÿè¡Œ
    # ğŸ’¡ `on.pull_request.branches` ã‚’ä½¿ã‚ãªã„å ´åˆã¯ã€ `github.event.pull_request.base.ref == 'main'` ã‚’å‰Šé™¤
    if: github.event.pull_request.base.ref == 'main' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    # ğŸ’¡ è¤‡æ•°ã®ãƒãƒ¼ã‚¸ãŒåŒæ™‚ã«è¡Œã‚ã‚ŒãŸå ´åˆã«å‚™ãˆã€ã‚¿ã‚°ä»˜ã‘ã‚¸ãƒ§ãƒ–ã®åŒæ™‚å®Ÿè¡Œã‚’é˜²ã
    concurrency:
      group: ${{ github.repository }}-tagging
      cancel-in-progress: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # ğŸ’¡ å…¨å±¥æ­´ã‚’å–å¾—ã—ã¦ã€git describe ãŒéå»ã®ã‚¿ã‚°ã‚’æ­£ã—ãè¦‹ã¤ã‘ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹
          fetch-depth: 0

      - name: Get latest stable tag
        id: get_tag
        run: |
          git fetch --tags
          # ğŸ’¡ vX.Y.Z å½¢å¼ã®å®‰å®šç‰ˆã‚¿ã‚°ã®ã¿ã‚’å¯¾è±¡ã«ã—ã€å­˜åœ¨ã—ãªã„å ´åˆã¯ v0.0.0 ã‚’ä½¿ç”¨
          latest_tag=$(git describe --tags --abbrev=0 --match "v[0-9]*.[0-9]*.[0-9]*" 2>/dev/null || echo "v0.0.0")
          echo "latest_tag=$latest_tag" >> $GITHUB_OUTPUT
          echo "Found latest tag: $latest_tag"

      - name: Determine next version
        id: bump
        run: |
          # PRã®ãƒ©ãƒ™ãƒ«ã‚’JSONã‹ã‚‰æŠ½å‡º
          label_names=$(jq -r '.pull_request.labels[].name' <<< '${{ toJson(github.event) }}')
          
          version="${{ steps.get_tag.outputs.latest_tag }}"
          version="${version#v}" # "v" ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’å‰Šé™¤
          
          IFS='.' read -r major minor patch <<< "$version"

          # ğŸ’¡ PRã®ãƒ©ãƒ™ãƒ«ã«åŸºã¥ã„ã¦ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
          if echo "$label_names" | grep -qi "major"; then # -i ã§å¤§æ–‡å­—å°æ–‡å­—ã‚’åŒºåˆ¥ã—ãªã„
            major=$((major+1)); minor=0; patch=0
            echo "Bumping major version"
          elif echo "$label_names" | grep -qi "minor"; then
            minor=$((minor+1)); patch=0
            echo "Bumping minor version"
          elif echo "$label_names" | grep -qi "patch"; then
            patch=$((patch+1))
            echo "Bumping patch version"
          else
            echo "No version label (major, minor, patch) found. Skipping."
            echo "new_tag=" >> $GITHUB_OUTPUT # new_tagã‚’ç©ºã«è¨­å®š
            exit 0 # æ­£å¸¸çµ‚äº†ã¨ã—ã¦ã‚¸ãƒ§ãƒ–ã‚’çµ‚äº†
          fi

          new_tag="v${major}.${minor}.${patch}"
          echo "New tag: $new_tag"
          echo "new_tag=$new_tag" >> $GITHUB_OUTPUT

      # ğŸ’¡ ã‚¿ã‚°ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹ãƒœãƒƒãƒˆã®æƒ…å ±ã‚’è¨­å®š
      - name: Configure Git
        if: steps.bump.outputs.new_tag != ''
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create and push new tag
        if: steps.bump.outputs.new_tag != '' # new_tag ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿å®Ÿè¡Œ
        run: |
          new_tag="${{ steps.bump.outputs.new_tag }}"
          # ğŸ’¡ ãƒãƒ¼ã‚¸ã‚³ãƒŸãƒƒãƒˆï¼ˆgithub.shaï¼‰ã«å¯¾ã—ã¦ã‚¿ã‚°ã‚’æ‰“ã¤
          echo "Creating and pushing tag: $new_tag"
          git tag "$new_tag" ${{ github.sha }}
          git push origin "$new_tag"